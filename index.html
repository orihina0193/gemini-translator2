<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ジェミニ翻訳者2 - Debug Mode</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        textarea { width: 100%; height: 100px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; padding: 10px; }
        button { width: 100%; padding: 12px; margin-top: 10px; background: #007aff; color: white; border: none; border-radius: 8px; font-weight: bold; }
        #status { font-size: 12px; color: #666; margin-top: 10px; padding: 5px; border-bottom: 1px solid #eee; }
        #result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; white-space: pre-wrap; border: 1px solid #ddd; }
        .error-msg { color: #d93025; background: #fce8e6; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px; }
    </style>
</head>
<body>
    <h1>ジェミニ翻訳者2</h1>
    <div id="status">APIキー読み込み中...</div>
    
    <textarea id="input" placeholder="ここに翻訳したい文章を入力..."></textarea>
    <button onclick="translateText()">翻訳実行</button>
    
    <div id="result">結果がここに表示されます</div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('key');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');

        if (!apiKey) {
            statusDiv.innerHTML = "<b style='color:red;'>APIキーが見つかりません。?key=... を確認してください。</b>";
        } else {
            statusDiv.textContent = "APIキー認識完了。準備OK！";
        }

        async function translateText() {
            const input = document.getElementById('input').value;
            if (!input) return;

            statusDiv.textContent = "モデル収集中...";
            try {
                // モデルリストを取得
                const mRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const mData = await mRes.json();
                
                if (mData.error) {
                    throw new Error(`APIエラー: ${mData.error.message}`);
                }

                // 2.0-flash を最優先で探すロジック
                const models = mData.models.map(m => m.name.replace('models/', ''));
                const targetModel = models.find(m => m.includes('2.0-flash')) || 
                                   models.find(m => m.includes('1.5-flash')) || 
                                   "gemini-1.5-flash";

                statusDiv.textContent = `使用モデル: ${targetModel}`;

                // 翻訳リクエスト
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${targetModel}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Translate the following text to Japanese. Return ONLY the translated text.\n\n" + input }] }]
                    })
                });

                const json = await res.json();

                if (json.error) {
                    resultDiv.innerHTML = `<div class="error-msg">APIからのエラー回答: ${json.error.message}</div>`;
                } else if (json.candidates && json.candidates[0].content) {
                    resultDiv.textContent = json.candidates[0].content.parts[0].text.trim();
                    statusDiv.textContent = "翻訳成功！";
                } else {
                    resultDiv.innerHTML = `<div class="error-msg">レスポンス形式が異常です。JSONを確認: ${JSON.stringify(json)}</div>`;
                }

            } catch (e) {
                resultDiv.innerHTML = `<div class="error-msg">実行エラー: ${e.message}</div>`;
                statusDiv.textContent = "エラー発生";
            }
        }
    </script>
</body>
</html>
